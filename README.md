# Airflow Data Pipeline

–°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è ETL –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –Ω–∞ –±–∞–∑–µ Apache Airflow –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π —Å–ª–æ–µ–≤ ODS (Operational Data Store) –∏ DDS (Data Delivery Store).

## üöÄ –ë—ã—Å—Ç—Ä—ã–π –∑–∞–ø—É—Å–∫

```bash
# –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
git clone <repository-url>
cd airflow-data-pipeline

# –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
docker compose up -d
```

–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ —Å–µ—Ä–≤–∏—Å—ã:
- **Airflow UI**: http://localhost:8080 (admin/admin)
- **PostgreSQL**: localhost:5432 (airflow/airflow)

## üìÅ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
airflow-data-pipeline/
‚îú‚îÄ‚îÄ dags/                    # DAG —Ñ–∞–π–ª—ã Airflow
‚îÇ   ‚îú‚îÄ‚îÄ example_dag.py       # –ü—Ä–∏–º–µ—Ä –±–∞–∑–æ–≤–æ–≥–æ DAG
‚îÇ   ‚îú‚îÄ‚îÄ ods_load_accounts_dag.py    # –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ ODS —Å–ª–æ–π
‚îÇ   ‚îú‚îÄ‚îÄ dds_transform_accounts_dag.py # –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è ODS ‚Üí DDS
‚îÇ   ‚îî‚îÄ‚îÄ utils/              # –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è DAG
‚îÇ       ‚îî‚îÄ‚îÄ job_loader.py   # –ó–∞–≥—Ä—É–∑—á–∏–∫ job —Å–∫—Ä–∏–ø—Ç–æ–≤
‚îú‚îÄ‚îÄ jobs/                   # Python ETL —Å–∫—Ä–∏–ø—Ç—ã
‚îÇ   ‚îî‚îÄ‚îÄ example_job.py      # –ü—Ä–∏–º–µ—Ä job —Å–∫—Ä–∏–ø—Ç–∞
‚îú‚îÄ‚îÄ config/                 # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
‚îÇ   ‚îú‚îÄ‚îÄ connections.json    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
‚îÇ   ‚îî‚îÄ‚îÄ init.sql           # –°—Ö–µ–º–∞ –ë–î –∏ –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
‚îú‚îÄ‚îÄ requirements.txt        # Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ docker-compose.yml     # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤
‚îî‚îÄ‚îÄ .env                   # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
```

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

### –°–ª–æ–∏ –¥–∞–Ω–Ω—ã—Ö:
- **ODS (Operational Data Store)**: –°–ª–æ–π –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ "—Å—ã—Ä—ã—Ö" –¥–∞–Ω–Ω—ã—Ö
- **DDS (Data Delivery Store)**: –°–ª–æ–π –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏

### –°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:
```sql
-- ODS: —Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ —Å—á–µ—Ç–æ–≤
ods.accounts (
    id, account_number, contractor_inn, amount, created_at
)

-- DDS: –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ –∏ –¥–∞–Ω–Ω—ã–µ
dds.contractors (
    id, inn, name
)

dds.accounts (
    id, account_number, contractor_id, amount, created_at
)
```

## üîÑ ETL –ø—Ä–æ—Ü–µ—Å—Å—ã

### 1. –ó–∞–≥—Ä—É–∑–∫–∞ –≤ ODS (ods_load_accounts_dag)
- –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ —Å—á–µ—Ç–æ–≤ –≤ —Ç–∞–±–ª–∏—Ü—É `ods.accounts`
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏—Å—Ö–æ–¥–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è staging –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö

### 2. –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –≤ DDS (dds_transform_accounts_dag)
- –ò–∑–≤–ª–µ–∫–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ ODS —Å–ª–æ—è
- –°–æ–∑–¥–∞–µ—Ç/–æ–±–Ω–æ–≤–ª—è–µ—Ç —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤ –≤ `dds.contractors`
- –§–æ—Ä–º–∏—Ä—É–µ—Ç –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Å—á–µ—Ç–∞ –≤ `dds.accounts`
- –†–µ–∞–ª–∏–∑—É–µ—Ç SCD Type 1 –¥–ª—è –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤

## üõ†Ô∏è –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ ETL job:

1. **–°–æ–∑–¥–∞–π—Ç–µ job —Å–∫—Ä–∏–ø—Ç –≤ `/jobs/`:**
```python
def my_etl_job():
    # –í–∞—à–∞ –ª–æ–≥–∏–∫–∞ ETL
    pass
```

2. **–î–æ–±–∞–≤—å—Ç–µ DAG –≤ `/dags/`:**
```python
from airflow import DAG
from airflow.operators.python import PythonOperator

with DAG(dag_id="my_etl_dag", ...) as dag:
    my_task = PythonOperator(
        task_id="run_my_etl",
        python_callable=my_etl_job
    )
```

3. **–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ Airflow –¥–ª—è –ø–æ–¥—Ö–≤–∞—Ç–∞ –Ω–æ–≤–æ–≥–æ DAG**

### –†–∞–±–æ—Ç–∞ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö:

```python
import psycopg2

conn = psycopg2.connect(
    host="postgres",
    database="airflow", 
    user="airflow",
    password="airflow"
)

# ODS —Å–ª–æ–π - –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å—ã—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
cursor.execute("""
    INSERT INTO ods.accounts(account_number, contractor_inn, amount)
    VALUES (%s, %s, %s)
""", (acc_number, inn, amount))

# DDS —Å–ª–æ–π - –¥–ª—è –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
cursor.execute("""
    INSERT INTO dds.contractors(inn) 
    VALUES (%s) ON CONFLICT (inn) DO NOTHING
""", (inn,))
```

## üì¶ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

–û—Å–Ω–æ–≤–Ω—ã–µ Python –ø–∞–∫–µ—Ç—ã:
- `psycopg2-binary` - —Ä–∞–±–æ—Ç–∞ —Å PostgreSQL
- `pandas` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö
- `requests` - HTTP –∑–∞–ø—Ä–æ—Å—ã

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (.env):
```bash
POSTGRES_USER=airflow
POSTGRES_PASSWORD=airflow
POSTGRES_DB=airflow
```

### –ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è Airflow:
–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ `config/connections.json` –∏ –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã —á–µ—Ä–µ–∑ UI Airflow.

## üß¨ –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏

- **DAG —Ñ–∞–π–ª—ã**: —Ç–æ–ª—å–∫–æ –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Ç–æ–∫–æ–º
- **Job —Å–∫—Ä–∏–ø—Ç—ã**: –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö
- **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏**: —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ `/config/`
- **–°–µ–∫—Ä–µ—Ç—ã**: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –¥–æ–±–∞–≤–ª—è–π—Ç–µ –ª–æ–≥–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ ETL –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
- **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**: —Ä–µ–∞–ª–∏–∑—É–π—Ç–µ retry –ª–æ–≥–∏–∫—É –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

- **Airflow UI**: http://localhost:8080 - –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ DAG –∏ –∑–∞–¥–∞—á
- **–õ–æ–≥–∏**: –¥–æ—Å—Ç—É–ø–Ω—ã –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ Airflow –¥–ª—è –∫–∞–∂–¥–æ–π –∑–∞–¥–∞—á–∏
- **–°—Ç–∞—Ç—É—Å**: –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è ETL –ø–∞–π–ø–ª–∞–π–Ω–æ–≤
